from flask import render_template, request, redirect, url_for, session, flash, jsonify
from werkzeug.security import generate_password_hash, check_password_hash
from models.database import get_db_connection
from utils.decorators import admin_required, permission_required, PERMISSIONS
import mysql.connector
import json
import os
from werkzeug.utils import secure_filename
from config import Config

def configure_admin_routes(app):
    
    # Fun√ß√£o auxiliar para verificar arquivos permitidos
    def allowed_file(filename):
        return '.' in filename and filename.rsplit('.', 1)[1].lower() in Config.ALLOWED_EXTENSIONS

    # Context processor para injetar user_cargo em todos os templates
    @app.context_processor
    def inject_user_cargo():
        return dict(user_cargo=session.get('admin_cargo', '').lower())

    @app.route('/admin/login', methods=['GET', 'POST'])
    def admin_login():
        if request.method == 'POST':
            email = request.form.get('email', '').strip().lower()
            senha = request.form.get('senha', '')
            if not email or not senha:
                flash('‚ùå Preencha todos os campos.', 'error')
                return render_template('admin/login.html')
            try:
                conn = get_db_connection()
                if not conn:
                    flash('Erro ao conectar ao banco de dados.', 'error')
                    return render_template('admin/login.html')
                cursor = conn.cursor(dictionary=True)
                cursor.execute("SELECT * FROM funcionarios WHERE email = %s AND ativo = TRUE", (email,))
                admin = cursor.fetchone()
                if admin and check_password_hash(admin['senha'], senha):
                    session['admin_id'] = admin['id_funcionario']
                    session['admin_nome'] = admin['nome']
                    session['admin_cargo'] = admin['cargo']
                    cursor.execute("UPDATE funcionarios SET ultimo_login = NOW() WHERE id_funcionario = %s", (admin['id_funcionario'],))
                    conn.commit()
                    flash(f'üéâ Bem-vindo, {admin["nome"]}!', 'success')
                    return redirect(url_for('admin_dashboard'))
                else:
                    flash('‚ùå Credenciais inv√°lidas.', 'error')
            except mysql.connector.Error as err:
                flash(f'Erro ao fazer login: {err}', 'error')
            finally:
                if conn and conn.is_connected():
                    cursor.close()
                    conn.close()
        return render_template('admin/login.html')

    @app.route('/admin/logout')
    def admin_logout():
        session.pop('admin_id', None)
        session.pop('admin_nome', None)
        session.pop('admin_cargo', None)
        flash('üëã Logout realizado com sucesso!', 'info')
        return redirect(url_for('admin_login'))

    @app.route('/admin/dashboard')
    @admin_required
    def admin_dashboard():
        user_cargo = session.get('admin_cargo', '').lower()
        
        total_clientes = 0
        total_produtos = 0
        pedidos_hoje = 0
        receita_hoje = 0
        diagnosticos_pendentes = 0
        estoque_baixo = []
        pedidos_recentes = []
        diagnosticos_recentes = []
        
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/dashboard.html', 
                                     total_clientes=total_clientes,
                                     total_produtos=total_produtos,
                                     pedidos_hoje=pedidos_hoje,
                                     receita_hoje=receita_hoje,
                                     diagnosticos_pendentes=diagnosticos_pendentes,
                                     estoque_baixo=estoque_baixo,
                                     pedidos_recentes=pedidos_recentes,
                                     diagnosticos_recentes=diagnosticos_recentes,
                                     user_cargo=user_cargo)
            
            cursor = conn.cursor(dictionary=True)
            
            # Consulta para total de produtos (todos os cargos podem ver)
            cursor.execute("SELECT COUNT(*) as total FROM produto WHERE ativo = TRUE")
            total_produtos = cursor.fetchone()['total']
            
            # Consulta para total de clientes (admin, gerente, vendedor)
            if user_cargo in ['admin', 'gerente', 'vendedor']:
                cursor.execute("SELECT COUNT(*) as total FROM clientes WHERE ativo = TRUE")
                total_clientes = cursor.fetchone()['total']
            
            # Consulta para pedidos de hoje (admin, gerente, vendedor)
            if user_cargo in ['admin', 'gerente', 'vendedor']:
                cursor.execute("SELECT COUNT(*) as total FROM pedidos WHERE DATE(data_pedido) = CURDATE()")
                pedidos_hoje = cursor.fetchone()['total']
            
            # Consulta para receita de hoje (admin, gerente, vendedor)
            if user_cargo in ['admin', 'gerente', 'vendedor']:
                cursor.execute("SELECT SUM(total) as total FROM pedidos WHERE DATE(data_pedido) = CURDATE() AND status != 'cancelado'")
                receita_result = cursor.fetchone()
                receita_hoje = receita_result['total'] or 0
            
            # Consulta para diagn√≥sticos pendentes (admin, gerente, suporte)
            if user_cargo in ['admin', 'gerente', 'suporte']:
                try:
                    cursor.execute("SELECT COUNT(*) as total FROM diagnosticos WHERE status = 'recebido' OR status = 'em_analise'")
                    diagnosticos_pendentes = cursor.fetchone()['total']
                except mysql.connector.Error:
                    diagnosticos_pendentes = 0
            
            # Consulta para estoque baixo (admin, gerente, vendedor)
            if user_cargo in ['admin', 'gerente', 'vendedor']:
                try:
                    cursor.execute("SELECT * FROM produto WHERE estoque <= 5 AND ativo = TRUE ORDER BY estoque ASC LIMIT 5")
                    estoque_baixo = cursor.fetchall()
                except mysql.connector.Error:
                    estoque_baixo = []
            
            # Consulta para pedidos recentes (admin, gerente, vendedor)
            if user_cargo in ['admin', 'gerente', 'vendedor']:
                try:
                    cursor.execute("SELECT p.*, c.nome as cliente_nome FROM pedidos p JOIN clientes c ON p.id_cliente = c.id_cliente ORDER BY p.data_pedido DESC LIMIT 5")
                    pedidos_recentes = cursor.fetchall()
                except mysql.connector.Error:
                    pedidos_recentes = []
            
            # Consulta para diagn√≥sticos recentes (admin, gerente, suporte)
            if user_cargo in ['admin', 'gerente', 'suporte']:
                try:
                    cursor.execute("SELECT * FROM diagnosticos ORDER BY data_entrada DESC LIMIT 5")
                    diagnosticos_recentes = cursor.fetchall()
                except mysql.connector.Error:
                    diagnosticos_recentes = []
            
            return render_template('admin/dashboard.html', 
                                 total_clientes=total_clientes,
                                 total_produtos=total_produtos,
                                 pedidos_hoje=pedidos_hoje,
                                 receita_hoje=receita_hoje,
                                 diagnosticos_pendentes=diagnosticos_pendentes,
                                 estoque_baixo=estoque_baixo,
                                 pedidos_recentes=pedidos_recentes,
                                 diagnosticos_recentes=diagnosticos_recentes,
                                 user_cargo=user_cargo)
                                 
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar dashboard: {err}', 'error')
            return render_template('admin/dashboard.html', 
                                 total_clientes=total_clientes,
                                 total_produtos=total_produtos,
                                 pedidos_hoje=pedidos_hoje,
                                 receita_hoje=receita_hoje,
                                 diagnosticos_pendentes=diagnosticos_pendentes,
                                 estoque_baixo=estoque_baixo,
                                 pedidos_recentes=pedidos_recentes,
                                 diagnosticos_recentes=diagnosticos_recentes,
                                 user_cargo=user_cargo)
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # PRODUTOS - Admin, Gerente e Vendedor (apenas visualiza√ß√£o)
    @app.route('/admin/produtos')
    @permission_required(['admin', 'gerente', 'vendedor'])
    def admin_produtos():
        user_cargo = session.get('admin_cargo', '').lower()
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/produtos.html', produtos=[], user_cargo=user_cargo)
            cursor = conn.cursor(dictionary=True)
            categoria = request.args.get('categoria')
            busca = request.args.get('busca')
            query = "SELECT * FROM produto WHERE 1=1"
            params = []
            if categoria:
                query += " AND categoria = %s"
                params.append(categoria)
            if busca:
                query += " AND (nome LIKE %s OR marca LIKE %s)"
                params.extend([f"%{busca}%", f"%{busca}%"])
            query += " ORDER BY data_cadastro DESC"
            cursor.execute(query, params)
            produtos = cursor.fetchall()
            cursor.execute("SELECT DISTINCT categoria FROM produto ORDER BY categoria")
            categorias = [row['categoria'] for row in cursor.fetchall()]
            return render_template('admin/produtos.html', produtos=produtos, categorias=categorias, user_cargo=user_cargo)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar produtos: {err}', 'error')
            return render_template('admin/produtos.html', produtos=[], user_cargo=user_cargo)
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/produto/novo', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_novo_produto():
        if request.method == 'POST':
            nome = request.form.get('nome', '').strip()
            marca = request.form.get('marca', '').strip()
            preco = request.form.get('preco', '0').replace(',', '.')
            descricao = request.form.get('descricao', '').strip()
            estoque = request.form.get('estoque', '0')
            categoria = request.form.get('categoria', '').strip()
            peso = request.form.get('peso', '0').replace(',', '.')
            dimensoes = request.form.get('dimensoes', '').strip()
            destaque = request.form.get('destaque') == 'on'
            
            if not all([nome, marca, preco, categoria]):
                flash('‚ùå Preencha todos os campos obrigat√≥rios.', 'error')
                return render_template('admin/produto_form.html')
            
            try:
                conn = get_db_connection()
                if not conn:
                    flash('Erro ao conectar ao banco de dados.', 'error')
                    return render_template('admin/produto_form.html')
                
                cursor = conn.cursor()
                
                imagens = []
                if 'imagens' in request.files:
                    files = request.files.getlist('imagens')
                    for file in files:
                        if file and allowed_file(file.filename):
                            filename = secure_filename(file.filename)
                            from uuid import uuid4
                            unique_filename = f"{uuid4().hex}_{filename}"
                            filepath = os.path.join(Config.UPLOAD_FOLDER, unique_filename)
                            os.makedirs(os.path.dirname(filepath), exist_ok=True)
                            file.save(filepath)
                            imagens.append(unique_filename)
                
                cursor.execute("""
                    INSERT INTO produto (nome, marca, preco, descricao, estoque, categoria, imagens, peso, dimensoes, destaque)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
                """, (nome, marca, float(preco), descricao, int(estoque), categoria, json.dumps(imagens) if imagens else None,
                      float(peso) if peso else 0, dimensoes, destaque))
                
                conn.commit()
                
                if session.get('admin_id'):
                    try:
                        cursor.execute("""
                            INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                            VALUES (%s, 'CADASTRO', 'PRODUTOS', %s)
                        """, (session['admin_id'], f'Produto cadastrado: {nome}'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                
                flash('‚úÖ Produto cadastrado com sucesso!', 'success')
                return redirect(url_for('admin_produtos'))
            
            except mysql.connector.Error as err:
                flash(f'Erro ao cadastrar produto: {err}', 'error')
            
            finally:
                if conn and conn.is_connected():
                    cursor.close()
                    conn.close()
        
        return render_template('admin/produto_form.html')

    # CLIENTES - Admin, Gerente e Vendedor (apenas visualiza√ß√£o)
    @app.route('/admin/clientes')
    @permission_required(['admin', 'gerente', 'vendedor'])
    def admin_clientes():
        user_cargo = session.get('admin_cargo', '').lower()
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/clientes.html', clientes=[], user_cargo=user_cargo)
            cursor = conn.cursor(dictionary=True)
            busca = request.args.get('busca')
            query = "SELECT * FROM clientes WHERE 1=1"
            params = []
            if busca:
                query += " AND (nome LIKE %s OR email LIKE %s OR cpf LIKE %s)"
                params.extend([f"%{busca}%", f"%{busca}%", f"%{busca}%"])
            query += " ORDER BY data_cadastro DESC"
            cursor.execute(query, params)
            clientes = cursor.fetchall()
            return render_template('admin/clientes.html', clientes=clientes, user_cargo=user_cargo)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar clientes: {err}', 'error')
            return render_template('admin/clientes.html', clientes=[], user_cargo=user_cargo)
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # FUNCION√ÅRIOS - Apenas Admin
    @app.route('/admin/funcionarios')
    @permission_required(['admin'])
    def admin_funcionarios():
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/funcionarios.html', funcionarios=[])
            cursor = conn.cursor(dictionary=True)
            cursor.execute("SELECT * FROM funcionarios ORDER BY data_cadastro DESC")
            funcionarios = cursor.fetchall()
            return render_template('admin/funcionarios.html', funcionarios=funcionarios)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar funcion√°rios: {err}', 'error')
            return render_template('admin/funcionarios.html', funcionarios=[])
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # OFERTAS - Admin e Gerente
    @app.route('/admin/ofertas')
    @permission_required(['admin', 'gerente'])
    def admin_ofertas():
        try:
            conn = get_db_connection()
            cursor = conn.cursor(dictionary=True)
            cursor.execute("""
                SELECT o.id_oferta, o.desconto, o.preco_original, o.preco_com_desconto,
                       o.validade, o.ativa, p.nome AS nome_produto
                FROM ofertas o
                JOIN produto p ON o.id_produto = p.id_produto
                ORDER BY o.validade DESC
            """)
            ofertas = cursor.fetchall()
            cursor.close()
            conn.close()
            return render_template('admin/ofertas.html', ofertas=ofertas)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar ofertas: {err}', 'error')
            return render_template('admin/ofertas.html', ofertas=[])

    # CONCORRENTES - Admin e Gerente
    @app.route('/admin/concorrentes')
    @permission_required(['admin', 'gerente'])
    def admin_concorrentes():
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/concorrentes.html', concorrentes=[])
            
            cursor = conn.cursor(dictionary=True)
            
            cursor.execute("""
                SELECT * FROM concorrentes 
                ORDER BY data_cadastro DESC
            """)
            concorrentes = cursor.fetchall()
            
            return render_template('admin/concorrentes.html', concorrentes=concorrentes)
            
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar concorrentes: {err}', 'error')
            return render_template('admin/concorrentes.html', concorrentes=[])
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # CONTATOS - Admin e Gerente
    @app.route('/admin/contatos')
    @permission_required(['admin', 'gerente'])
    def admin_contatos():
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/contatos.html', contatos=[])
            
            cursor = conn.cursor(dictionary=True)
            
            cursor.execute("""
                SELECT * FROM suporte 
                ORDER BY data_envio DESC
            """)
            contatos = cursor.fetchall()
            
            return render_template('admin/contatos.html', contatos=contatos)
            
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar contatos: {err}', 'error')
            return render_template('admin/contatos.html', contatos=[])
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # DIAGN√ìSTICOS - Admin, Gerente e Suporte
    @app.route('/admin/diagnosticos')
    @permission_required(['admin', 'gerente', 'suporte'])
    def admin_diagnosticos():
        user_cargo = session.get('admin_cargo', '').lower()
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/diagnosticos.html', diagnosticos=[], user_cargo=user_cargo)
            cursor = conn.cursor(dictionary=True)
            status = request.args.get('status')
            query = "SELECT d.*, f.nome as tecnico_nome FROM diagnosticos d LEFT JOIN funcionarios f ON d.tecnico_responsavel = f.id_funcionario WHERE 1=1"
            params = []
            if status:
                query += " AND d.status = %s"
                params.append(status)
            query += " ORDER BY d.data_entrada DESC"
            cursor.execute(query, params)
            diagnosticos = cursor.fetchall()
            return render_template('admin/diagnosticos.html', diagnosticos=diagnosticos, user_cargo=user_cargo)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar diagn√≥sticos: {err}', 'error')
            return render_template('admin/diagnosticos.html', diagnosticos=[], user_cargo=user_cargo)
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # RELAT√ìRIOS - Admin, Gerente e Vendedor (apenas visualiza√ß√£o)
    @app.route('/admin/relatorios')
    @permission_required(['admin', 'gerente', 'vendedor'])
    def admin_relatorios():
        user_cargo = session.get('admin_cargo', '').lower()
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/relatorios.html', user_cargo=user_cargo)
            cursor = conn.cursor(dictionary=True)
            
            # Tentar buscar relat√≥rios mensais
            try:
                cursor.execute("SELECT * FROM view_relatorios_mensais LIMIT 12")
                relatorios_mensais = cursor.fetchall()
            except mysql.connector.Error:
                relatorios_mensais = []
            
            # Tentar buscar produtos mais vendidos
            try:
                cursor.execute("SELECT * FROM view_produtos_mais_vendidos LIMIT 10")
                produtos_mais_vendidos = cursor.fetchall()
            except mysql.connector.Error:
                produtos_mais_vendidos = []
            
            # Tentar buscar clientes ativos
            try:
                cursor.execute("SELECT * FROM view_clientes_ativos LIMIT 10")
                clientes_ativos = cursor.fetchall()
            except mysql.connector.Error:
                clientes_ativos = []
            
            # Tentar buscar estoque cr√≠tico
            try:
                cursor.execute("SELECT * FROM view_estoque_critico")
                estoque_critico = cursor.fetchall()
            except mysql.connector.Error:
                estoque_critico = []
            
            return render_template('admin/relatorios.html', 
                                 relatorios_mensais=relatorios_mensais,
                                 produtos_mais_vendidos=produtos_mais_vendidos, 
                                 clientes_ativos=clientes_ativos, 
                                 estoque_critico=estoque_critico,
                                 user_cargo=user_cargo)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar relat√≥rios: {err}', 'error')
            return render_template('admin/relatorios.html', user_cargo=user_cargo)
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    # COMBOS - Admin e Gerente
    @app.route('/admin/combos')
    @permission_required(['admin', 'gerente'])
    def admin_listar_combos():
        conn = None
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return render_template('admin/combos.html', combos=[])
            
            cursor = conn.cursor(dictionary=True)
            
            # Verificar se a tabela combos existe
            cursor.execute("""
                SELECT COUNT(*) as existe
                FROM information_schema.tables 
                WHERE table_schema = DATABASE() 
                AND table_name = 'combos'
            """)
            tabela_existe = cursor.fetchone()['existe'] > 0
            
            combos_list = []
            
            if tabela_existe:
                # Buscar todos os combos
                cursor.execute("SELECT * FROM combos ORDER BY data_criacao DESC")
                combos = cursor.fetchall()
                
                # Converter para lista de dicion√°rios
                for combo in combos:
                    combos_list.append({
                        'id_combo': combo['id_combo'],
                        'nome': combo.get('nome', 'Sem nome'),
                        'descricao': combo.get('descricao', ''),
                        'marca': combo.get('marca', ''),
                        'categoria': combo.get('categoria', ''),
                        'estoque': combo.get('estoque', 0),
                        'preco': float(combo.get('preco', 0)),
                        'ativo': bool(combo.get('ativo', True)),
                        'destaque': bool(combo.get('destaque', False)),
                        'imagem': combo.get('imagem'),
                        'data_criacao': combo.get('data_criacao')
                    })
            
            if not combos_list:
                flash('Nenhum combo cadastrado ainda.', 'info')
            
            return render_template('admin/combos.html', combos=combos_list)
            
        except Exception as e:
            print(f"ERRO: {str(e)}")
            flash(f'Erro ao carregar combos: {str(e)}', 'error')
            return render_template('admin/combos.html', combos=[])
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/ofertas/nova', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_nova_oferta():
        conn = get_db_connection()
        cursor = conn.cursor(dictionary=True)

        # Buscar produtos ativos
        cursor.execute("SELECT id_produto, nome, preco FROM produto WHERE ativo = TRUE ORDER BY nome ASC")
        produtos = cursor.fetchall()

        if request.method == 'POST':
            id_produto = request.form.get('id_produto')
            desconto = float(request.form.get('desconto', 0))
            validade = request.form.get('validade')

            # Buscar pre√ßo original do produto
            cursor.execute("SELECT preco FROM produto WHERE id_produto = %s", (id_produto,))
            produto = cursor.fetchone()
            if not produto:
                flash('Produto n√£o encontrado.', 'error')
                return redirect(url_for('admin_nova_oferta'))

            preco_original = float(produto['preco'])
            preco_com_desconto = preco_original - (preco_original * (desconto / 100))

            # Inserir oferta
            cursor.execute("""
                INSERT INTO ofertas (id_produto, desconto, preco_original, preco_com_desconto, validade, ativa)
                VALUES (%s, %s, %s, %s, %s, TRUE)
            """, (id_produto, desconto, preco_original, preco_com_desconto, validade))
            conn.commit()

            cursor.close()
            conn.close()
            flash('üéâ Oferta criada com sucesso!', 'success')
            return redirect(url_for('admin_ofertas'))

        cursor.close()
        conn.close()
        return render_template('admin/nova_oferta.html', produtos=produtos)

    @app.route('/admin/oferta/editar/<int:id_oferta>', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_editar_oferta(id_oferta):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_ofertas'))
            
            cursor = conn.cursor(dictionary=True)
            
            if request.method == 'POST':
                id_produto = request.form.get('id_produto')
                desconto = float(request.form.get('desconto', 0))
                validade = request.form.get('validade')
                ativa = request.form.get('ativa') == 'on'
                
                # Buscar pre√ßo original do produto
                cursor.execute("SELECT preco FROM produto WHERE id_produto = %s", (id_produto,))
                produto = cursor.fetchone()
                if not produto:
                    flash('Produto n√£o encontrado.', 'error')
                    return redirect(url_for('admin_editar_oferta', id_oferta=id_oferta))
                
                preco_original = float(produto['preco'])
                preco_com_desconto = preco_original - (preco_original * (desconto / 100))
                
                # Atualizar oferta
                cursor.execute("""
                    UPDATE ofertas 
                    SET id_produto = %s, desconto = %s, preco_original = %s, 
                        preco_com_desconto = %s, validade = %s, ativa = %s
                    WHERE id_oferta = %s
                """, (id_produto, desconto, preco_original, preco_com_desconto, validade, ativa, id_oferta))
                conn.commit()
                
                # Log
                if session.get('admin_id'):
                    try:
                        cursor.execute("""
                            INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                            VALUES (%s, 'EDICAO', 'OFERTAS', %s)
                        """, (session['admin_id'], f'Oferta editada: ID {id_oferta}'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                
                flash('‚úÖ Oferta atualizada com sucesso!', 'success')
                return redirect(url_for('admin_ofertas'))
            
            else:
                # GET - carregar dados da oferta
                cursor.execute("""
                    SELECT o.*, p.nome as nome_produto 
                    FROM ofertas o
                    JOIN produto p ON o.id_produto = p.id_produto
                    WHERE o.id_oferta = %s
                """, (id_oferta,))
                oferta = cursor.fetchone()
                
                if not oferta:
                    flash('‚ùå Oferta n√£o encontrada.', 'error')
                    return redirect(url_for('admin_ofertas'))
                
                # Buscar produtos ativos
                cursor.execute("SELECT id_produto, nome, preco FROM produto WHERE ativo = TRUE ORDER BY nome ASC")
                produtos = cursor.fetchall()
                
                return render_template('admin/editar_oferta.html', oferta=oferta, produtos=produtos)
        
        except mysql.connector.Error as err:
            flash(f'Erro ao editar oferta: {err}', 'error')
            return redirect(url_for('admin_ofertas'))
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/oferta/excluir/<int:id_oferta>', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_excluir_oferta(id_oferta):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_ofertas'))
            
            cursor = conn.cursor(dictionary=True)
            
            # Buscar nome do produto para o log
            cursor.execute("""
                SELECT p.nome 
                FROM ofertas o
                JOIN produto p ON o.id_produto = p.id_produto
                WHERE o.id_oferta = %s
            """, (id_oferta,))
            oferta = cursor.fetchone()
            
            if not oferta:
                flash('‚ùå Oferta n√£o encontrada.', 'error')
                return redirect(url_for('admin_ofertas'))
            
            nome_produto = oferta['nome']
            
            # Excluir oferta
            cursor.execute("DELETE FROM ofertas WHERE id_oferta = %s", (id_oferta,))
            conn.commit()
            
            # Log
            if session.get('admin_id'):
                try:
                    cursor.execute("""
                        INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                        VALUES (%s, 'EXCLUSAO', 'OFERTAS', %s)
                    """, (session['admin_id'], f'Oferta exclu√≠da: {nome_produto} (ID: {id_oferta})'))
                    conn.commit()
                except mysql.connector.Error:
                    pass
            
            flash(f'üóëÔ∏è Oferta de {nome_produto} exclu√≠da com sucesso!', 'success')
        
        except mysql.connector.Error as err:
            flash(f'Erro ao excluir oferta: {err}', 'error')
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()
        
        return redirect(url_for('admin_ofertas'))

    @app.route('/admin/produto/editar/<int:id_produto>', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_editar_produto(id_produto):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_produtos'))
            
            cursor = conn.cursor(dictionary=True)
            
            if request.method == 'POST':
                nome = request.form.get('nome', '').strip()
                marca = request.form.get('marca', '').strip()
                preco = request.form.get('preco', '0').replace(',', '.')
                descricao = request.form.get('descricao', '').strip()
                estoque = request.form.get('estoque', '0')
                categoria = request.form.get('categoria', '').strip()
                peso = request.form.get('peso', '0').replace(',', '.')
                dimensoes = request.form.get('dimensoes', '').strip()
                destaque = request.form.get('destaque') == 'on'
                ativo = request.form.get('ativo') == 'on'
                
                cursor.execute("SELECT imagens FROM produto WHERE id_produto = %s", (id_produto,))
                produto_atual = cursor.fetchone()
                imagens = json.loads(produto_atual['imagens']) if produto_atual['imagens'] else []
                
                if 'imagens' in request.files:
                    files = request.files.getlist('imagens')
                    for file in files:
                        if file and allowed_file(file.filename):
                            filename = secure_filename(file.filename)
                            from uuid import uuid4
                            unique_filename = f"{uuid4().hex}_{filename}"
                            filepath = os.path.join(Config.UPLOAD_FOLDER, unique_filename)
                            os.makedirs(os.path.dirname(filepath), exist_ok=True)
                            file.save(filepath)
                            imagens.append(unique_filename)
                
                imagens_remover = request.form.getlist('imagens_remover')
                imagens = [img for img in imagens if img not in imagens_remover]
                
                cursor.execute("""
                    UPDATE produto SET nome = %s, marca = %s, preco = %s, descricao = %s, estoque = %s, categoria = %s, 
                    imagens = %s, peso = %s, dimensoes = %s, destaque = %s, ativo = %s WHERE id_produto = %s
                """, (nome, marca, float(preco), descricao, int(estoque), categoria, json.dumps(imagens) if imagens else None,
                      float(peso) if peso else 0, dimensoes, destaque, ativo, id_produto))
                
                conn.commit()
                
                if session.get('admin_id'):
                    try:
                        cursor.execute("""
                            INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                            VALUES (%s, 'EDICAO', 'PRODUTOS', %s)
                        """, (session['admin_id'], f'Produto editado: {nome} (ID: {id_produto})'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                
                flash('‚úÖ Produto atualizado com sucesso!', 'success')
                return redirect(url_for('admin_produtos'))
            
            else:
                cursor.execute("SELECT * FROM produto WHERE id_produto = %s", (id_produto,))
                produto = cursor.fetchone()
                
                if not produto:
                    flash('‚ùå Produto n√£o encontrado.', 'error')
                    return redirect(url_for('admin_produtos'))
                
                # Processar imagens para exibi√ß√£o
                if produto.get('imagens'):
                    try:
                        produto['imagens'] = json.loads(produto['imagens'])
                    except:
                        produto['imagens'] = []
                
                return render_template('admin/produto_form.html', produto=produto)
        
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar produto: {err}', 'error')
            return redirect(url_for('admin_produtos'))
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/cliente/<int:id_cliente>')
    @permission_required(['admin', 'gerente', 'vendedor'])
    def admin_detalhes_cliente(id_cliente):
        user_cargo = session.get('admin_cargo', '').lower()
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_clientes'))
            cursor = conn.cursor(dictionary=True)
            cursor.execute("SELECT * FROM clientes WHERE id_cliente = %s", (id_cliente,))
            cliente = cursor.fetchone()
            if not cliente:
                flash('‚ùå Cliente n√£o encontrado.', 'error')
                return redirect(url_for('admin_clientes'))
            cursor.execute("SELECT * FROM pedidos WHERE id_cliente = %s ORDER BY data_pedido DESC", (id_cliente,))
            pedidos = cursor.fetchall()
            cursor.execute("SELECT * FROM enderecos WHERE id_cliente = %s ORDER BY principal DESC", (id_cliente,))
            enderecos = cursor.fetchall()
            return render_template('admin/cliente_detalhes.html', cliente=cliente, pedidos=pedidos, enderecos=enderecos, user_cargo=user_cargo)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar dados do cliente: {err}', 'error')
            return redirect(url_for('admin_clientes'))
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/contato/<int:id_suporte>', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_detalhes_contato(id_suporte):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_contatos'))
            
            cursor = conn.cursor(dictionary=True)
            
            if request.method == 'POST':
                status = request.form.get('status', 'pendente')
                observacoes = request.form.get('observacoes', '').strip()
                
                cursor.execute("""
                    UPDATE suporte 
                    SET status = %s, observacoes = %s
                    WHERE id_suporte = %s
                """, (status, observacoes, id_suporte))
                
                conn.commit()
                
                flash('‚úÖ Contato atualizado com sucesso!', 'success')
                return redirect(url_for('admin_contatos'))
            
            else:
                cursor.execute("SELECT * FROM suporte WHERE id_suporte = %s", (id_suporte,))
                contato = cursor.fetchone()
                
                if not contato:
                    flash('‚ùå Contato n√£o encontrado.', 'error')
                    return redirect(url_for('admin_contatos'))
                
                return render_template('admin/contato_detalhes.html', contato=contato)
        
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar contato: {err}', 'error')
            return redirect(url_for('admin_contatos'))
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/diagnostico/<int:id_diagnostico>', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente', 'suporte'])
    def admin_detalhes_diagnostico(id_diagnostico):
        user_cargo = session.get('admin_cargo', '').lower()
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_diagnosticos'))
            cursor = conn.cursor(dictionary=True)
            if request.method == 'POST':
                status = request.form.get('status')
                relatorio_final = request.form.get('relatorio_final', '').strip()
                pecas_defeito = request.form.get('pecas_defeito', '').strip()
                orcamento = request.form.get('orcamento', '0').replace(',', '.')
                observacoes = request.form.get('observacoes', '').strip()
                cursor.execute("""
                    UPDATE diagnosticos SET status = %s, relatorio_final = %s, pecas_defeito = %s, 
                    orcamento = %s, observacoes = %s, tecnico_responsavel = %s WHERE id_diagnostico = %s
                """, (status, relatorio_final, pecas_defeito, float(orcamento) if orcamento else 0, observacoes, session['admin_id'], id_diagnostico))
                if status == 'concluido':
                    cursor.execute("UPDATE diagnosticos SET data_conclusao = NOW() WHERE id_diagnostico = %s", (id_diagnostico,))
                conn.commit()
                flash('‚úÖ Diagn√≥stico atualizado com sucesso!', 'success')
                return redirect(url_for('admin_diagnosticos'))
            else:
                cursor.execute("""
                    SELECT d.*, f.nome as tecnico_nome FROM diagnosticos d 
                    LEFT JOIN funcionarios f ON d.tecnico_responsavel = f.id_funcionario WHERE d.id_diagnostico = %s
                """, (id_diagnostico,))
                diagnostico = cursor.fetchone()
                if not diagnostico:
                    flash('‚ùå Diagn√≥stico n√£o encontrado.', 'error')
                    return redirect(url_for('admin_diagnosticos'))
                return render_template('admin/diagnostico_detalhes.html', diagnostico=diagnostico, user_cargo=user_cargo)
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar diagn√≥stico: {err}', 'error')
            return redirect(url_for('admin_diagnosticos'))
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/concorrente/novo', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_novo_concorrente():
        if request.method == 'POST':
            nome = request.form.get('nome', '').strip()
            email = request.form.get('email', '').strip()
            telefone = request.form.get('telefone', '').strip()
            empresa = request.form.get('empresa', '').strip()
            cargo = request.form.get('cargo', '').strip()
            interesse = request.form.get('interesse', '').strip()
            mensagem = request.form.get('mensagem', '').strip()
            status = request.form.get('status', 'pendente')
            
            if not all([nome, email, empresa]):
                flash('‚ùå Preencha todos os campos obrigat√≥rios.', 'error')
                return render_template('admin/concorrente_form.html')
            
            try:
                conn = get_db_connection()
                if not conn:
                    flash('Erro ao conectar ao banco de dados.', 'error')
                    return render_template('admin/concorrente_form.html')
                
                cursor = conn.cursor()
                
                cursor.execute("""
                    INSERT INTO concorrentes (nome, email, telefone, empresa, cargo, interesse, mensagem, status)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                """, (nome, email, telefone, empresa, cargo, interesse, mensagem, status))
                
                conn.commit()
                
                # Log da a√ß√£o
                if session.get('admin_id'):
                    try:
                        cursor.execute("""
                            INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                            VALUES (%s, 'CADASTRO', 'CONCORRENTES', %s)
                        """, (session['admin_id'], f'Concorrente cadastrado: {nome}'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                
                flash('‚úÖ Concorrente cadastrado com sucesso!', 'success')
                return redirect(url_for('admin_concorrentes'))
            
            except mysql.connector.Error as err:
                flash(f'Erro ao cadastrar concorrente: {err}', 'error')
            
            finally:
                if conn and conn.is_connected():
                    cursor.close()
                    conn.close()
        
        return render_template('admin/concorrente_form.html')

    @app.route('/admin/concorrente/editar/<int:id_concorrente>', methods=['GET', 'POST'])
    @permission_required(['admin', 'gerente'])
    def admin_editar_concorrente(id_concorrente):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_concorrentes'))
            
            cursor = conn.cursor(dictionary=True)
            
            if request.method == 'POST':
                nome = request.form.get('nome', '').strip()
                email = request.form.get('email', '').strip()
                telefone = request.form.get('telefone', '').strip()
                empresa = request.form.get('empresa', '').strip()
                cargo = request.form.get('cargo', '').strip()
                interesse = request.form.get('interesse', '').strip()
                mensagem = request.form.get('mensagem', '').strip()
                status = request.form.get('status', 'pendente')
                observacoes = request.form.get('observacoes', '').strip()
                
                cursor.execute("""
                    UPDATE concorrentes 
                    SET nome = %s, email = %s, telefone = %s, empresa = %s, cargo = %s, 
                        interesse = %s, mensagem = %s, status = %s, observacoes = %s
                    WHERE id_concorrente = %s
                """, (nome, email, telefone, empresa, cargo, interesse, mensagem, status, observacoes, id_concorrente))
                
                conn.commit()
                
                # Log da a√ß√£o
                if session.get('admin_id'):
                    try:
                        cursor.execute("""
                            INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                            VALUES (%s, 'EDICAO', 'CONCORRENTES', %s)
                        """, (session['admin_id'], f'Concorrente editado: {nome} (ID: {id_concorrente})'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                
                flash('‚úÖ Concorrente atualizado com sucesso!', 'success')
                return redirect(url_for('admin_concorrentes'))
            
            else:
                cursor.execute("SELECT * FROM concorrentes WHERE id_concorrente = %s", (id_concorrente,))
                concorrente = cursor.fetchone()
                
                if not concorrente:
                    flash('‚ùå Concorrente n√£o encontrado.', 'error')
                    return redirect(url_for('admin_concorrentes'))
                
                return render_template('admin/concorrente_form.html', concorrente=concorrente)
        
        except mysql.connector.Error as err:
            flash(f'Erro ao editar concorrente: {err}', 'error')
            return redirect(url_for('admin_concorrentes'))
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/concorrente/excluir/<int:id_concorrente>', methods=['POST'])
    @permission_required(['admin', 'gerente'])
    def admin_excluir_concorrente(id_concorrente):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_concorrentes'))
            
            cursor = conn.cursor(dictionary=True)
            
            cursor.execute("SELECT nome FROM concorrentes WHERE id_concorrente = %s", (id_concorrente,))
            concorrente = cursor.fetchone()
            
            if not concorrente:
                flash('‚ùå Concorrente n√£o encontrado.', 'error')
                return redirect(url_for('admin_concorrentes'))
            
            cursor.execute("DELETE FROM concorrentes WHERE id_concorrente = %s", (id_concorrente,))
            conn.commit()
            
            # Log da a√ß√£o
            if session.get('admin_id'):
                try:
                    cursor.execute("""
                        INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao)
                        VALUES (%s, 'EXCLUSAO', 'CONCORRENTES', %s)
                    """, (session['admin_id'], f'Concorrente exclu√≠do: {concorrente["nome"]} (ID: {id_concorrente})'))
                    conn.commit()
                except mysql.connector.Error:
                    pass
            
            flash(f'üóëÔ∏è Concorrente {concorrente["nome"]} exclu√≠do com sucesso!', 'success')
        
        except mysql.connector.Error as err:
            flash(f'Erro ao excluir concorrente: {err}', 'error')
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()
        
        return redirect(url_for('admin_concorrentes'))

    @app.route('/admin/concorrente/<int:id_concorrente>')
    @permission_required(['admin', 'gerente'])
    def admin_detalhes_concorrente(id_concorrente):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_concorrentes'))
            
            cursor = conn.cursor(dictionary=True)
            
            cursor.execute("SELECT * FROM concorrentes WHERE id_concorrente = %s", (id_concorrente,))
            concorrente = cursor.fetchone()
            
            if not concorrente:
                flash('‚ùå Concorrente n√£o encontrado.', 'error')
                return redirect(url_for('admin_concorrentes'))
            
            return render_template('admin/concorrente_detalhes.html', concorrente=concorrente)
        
        except mysql.connector.Error as err:
            flash(f'Erro ao carregar concorrente: {err}', 'error')
            return redirect(url_for('admin_concorrentes'))
        
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/funcionario/novo', methods=['GET', 'POST'])
    @permission_required(['admin'])
    def admin_novo_funcionario():
        if request.method == 'POST':
            nome = request.form.get('nome', '').strip()
            email = request.form.get('email', '').strip().lower()
            senha = request.form.get('senha', '')
            cargo = request.form.get('cargo', 'vendedor')
            if not all([nome, email, senha]):
                flash('‚ùå Preencha todos os campos.', 'error')
                return render_template('admin/funcionario_form.html')
            if len(senha) < 6:
                flash('‚ùå A senha deve ter no m√≠nimo 6 caracteres.', 'error')
                return render_template('admin/funcionario_form.html')
            try:
                conn = get_db_connection()
                if not conn:
                    flash('Erro ao conectar ao banco de dados.', 'error')
                    return render_template('admin/funcionario_form.html')
                cursor = conn.cursor()
                cursor.execute("SELECT id_funcionario FROM funcionarios WHERE email = %s", (email,))
                if cursor.fetchone():
                    flash('‚ùå Este e-mail j√° est√° cadastrado.', 'error')
                    return render_template('admin/funcionario_form.html')
                senha_hash = generate_password_hash(senha)
                cursor.execute("INSERT INTO funcionarios (nome, email, senha, cargo) VALUES (%s, %s, %s, %s)", (nome, email, senha_hash, cargo))
                conn.commit()
                if session.get('admin_id'):
                    try:
                        cursor.execute("INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao) VALUES (%s, 'CADASTRO', 'FUNCIONARIOS', %s)",
                                      (session['admin_id'], f'Funcion√°rio cadastrado: {nome}'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                flash('‚úÖ Funcion√°rio cadastrado com sucesso!', 'success')
                return redirect(url_for('admin_funcionarios'))
            except mysql.connector.Error as err:
                flash(f'Erro ao cadastrar funcion√°rio: {err}', 'error')
            finally:
                if conn and conn.is_connected():
                    cursor.close()
                    conn.close()
        return render_template('admin/funcionario_form.html')

    @app.route('/admin/funcionario/editar/<int:id_funcionario>', methods=['GET', 'POST'])
    @permission_required(['admin'])
    def admin_editar_funcionario(id_funcionario):
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_funcionarios'))
            cursor = conn.cursor(dictionary=True)
            if request.method == 'POST':
                nome = request.form.get('nome', '').strip()
                email = request.form.get('email', '').strip().lower()
                cargo = request.form.get('cargo', 'vendedor')
                ativo = request.form.get('ativo') == 'on'
                nova_senha = request.form.get('nova_senha', '').strip()
                if not all([nome, email]):
                    flash('‚ùå Preencha todos os campos obrigat√≥rios.', 'error')
                    return redirect(url_for('admin_editar_funcionario', id_funcionario=id_funcionario))
                cursor.execute("SELECT id_funcionario FROM funcionarios WHERE email = %s AND id_funcionario != %s", (email, id_funcionario))
                if cursor.fetchone():
                    flash('‚ùå Este e-mail j√° est√° cadastrado em outro funcion√°rio.', 'error')
                    return redirect(url_for('admin_editar_funcionario', id_funcionario=id_funcionario))
                if nova_senha:
                    if len(nova_senha) < 6:
                        flash('‚ùå A senha deve ter no m√≠nimo 6 caracteres.', 'error')
                        return redirect(url_for('admin_editar_funcionario', id_funcionario=id_funcionario))
                    senha_hash = generate_password_hash(nova_senha)
                    cursor.execute("UPDATE funcionarios SET nome = %s, email = %s, cargo = %s, ativo = %s, senha = %s WHERE id_funcionario = %s",
                                  (nome, email, cargo, ativo, senha_hash, id_funcionario))
                else:
                    cursor.execute("UPDATE funcionarios SET nome = %s, email = %s, cargo = %s, ativo = %s WHERE id_funcionario = %s",
                                  (nome, email, cargo, ativo, id_funcionario))
                conn.commit()
                if session.get('admin_id'):
                    try:
                        cursor.execute("INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao) VALUES (%s, 'EDICAO', 'FUNCIONARIOS', %s)",
                                      (session['admin_id'], f'Funcion√°rio editado: {nome} (ID: {id_funcionario})'))
                        conn.commit()
                    except mysql.connector.Error:
                        pass
                flash('‚úÖ Funcion√°rio atualizado com sucesso!', 'success')
                return redirect(url_for('admin_funcionarios'))
            else:
                cursor.execute("SELECT * FROM funcionarios WHERE id_funcionario = %s", (id_funcionario,))
                funcionario = cursor.fetchone()
                if not funcionario:
                    flash('‚ùå Funcion√°rio n√£o encontrado.', 'error')
                    return redirect(url_for('admin_funcionarios'))
                return render_template('admin/funcionario_form.html', funcionario=funcionario, editando=True)
        except mysql.connector.Error as err:
            flash(f'Erro ao editar funcion√°rio: {err}', 'error')
            return redirect(url_for('admin_funcionarios'))
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()

    @app.route('/admin/funcionario/excluir/<int:id_funcionario>', methods=['POST'])
    @permission_required(['admin'])
    def admin_excluir_funcionario(id_funcionario):
        if id_funcionario == session.get('admin_id'):
            flash('‚ùå Voc√™ n√£o pode excluir sua pr√≥pria conta.', 'error')
            return redirect(url_for('admin_funcionarios'))
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_funcionarios'))
            cursor = conn.cursor(dictionary=True)
            cursor.execute("SELECT nome FROM funcionarios WHERE id_funcionario = %s", (id_funcionario,))
            funcionario = cursor.fetchone()
            if not funcionario:
                flash('‚ùå Funcion√°rio n√£o encontrado.', 'error')
                return redirect(url_for('admin_funcionarios'))
            nome_funcionario = funcionario['nome']
            cursor.execute("DELETE FROM funcionarios WHERE id_funcionario = %s", (id_funcionario,))
            conn.commit()
            if session.get('admin_id'):
                try:
                    cursor.execute("INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao) VALUES (%s, 'EXCLUSAO', 'FUNCIONARIOS', %s)",
                                  (session['admin_id'], f'Funcion√°rio exclu√≠do: {nome_funcionario} (ID: {id_funcionario})'))
                    conn.commit()
                except mysql.connector.Error:
                    pass
            flash(f'üóëÔ∏è Funcion√°rio {nome_funcionario} exclu√≠do com sucesso!', 'success')
        except mysql.connector.Error as err:
            flash(f'Erro ao excluir funcion√°rio: {err}', 'error')
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()
        return redirect(url_for('admin_funcionarios'))

    @app.route('/admin/funcionario/alternar-status/<int:id_funcionario>', methods=['POST'])
    @permission_required(['admin'])
    def admin_alternar_status_funcionario(id_funcionario):
        if id_funcionario == session.get('admin_id'):
            flash('‚ùå Voc√™ n√£o pode desativar sua pr√≥pria conta.', 'error')
            return redirect(url_for('admin_funcionarios'))
        try:
            conn = get_db_connection()
            if not conn:
                flash('Erro ao conectar ao banco de dados.', 'error')
                return redirect(url_for('admin_funcionarios'))
            cursor = conn.cursor(dictionary=True)
            cursor.execute("SELECT nome, ativo FROM funcionarios WHERE id_funcionario = %s", (id_funcionario,))
            funcionario = cursor.fetchone()
            if not funcionario:
                flash('‚ùå Funcion√°rio n√£o encontrado.', 'error')
                return redirect(url_for('admin_funcionarios'))
            novo_status = not funcionario['ativo']
            cursor.execute("UPDATE funcionarios SET ativo = %s WHERE id_funcionario = %s", (novo_status, id_funcionario))
            conn.commit()
            acao = 'ativado' if novo_status else 'desativado'
            if session.get('admin_id'):
                try:
                    cursor.execute("INSERT INTO logs_sistema (id_funcionario, acao, modulo, descricao) VALUES (%s, 'ALTERACAO', 'FUNCIONARIOS', %s)",
                                  (session['admin_id'], f'Funcion√°rio {acao}: {funcionario["nome"]} (ID: {id_funcionario})'))
                    conn.commit()
                except mysql.connector.Error:
                    pass
            status_msg = '‚úÖ ativado' if novo_status else 'üö´ desativado'
            flash(f'Funcion√°rio {funcionario["nome"]} foi {status_msg} com sucesso!', 'success')
        except mysql.connector.Error as err:
            flash(f'Erro ao alterar status: {err}', 'error')
        finally:
            if conn and conn.is_connected():
                cursor.close()
                conn.close()
        return redirect(url_for('admin_funcionarios'))