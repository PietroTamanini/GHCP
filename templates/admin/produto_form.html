{% extends "admin/base.html" %}

{% block title %}{{ 'Editar' if produto else 'Novo' }} Produto{% endblock %}
{% block page_title %}{{ '‚úèÔ∏è Editar' if produto else '‚ûï Novo' }} Produto{% endblock %}

{% block content %}
<div class="form-container">
    <form method="POST" enctype="multipart/form-data">
        <div class="form-grid">
            <!-- Informa√ß√µes B√°sicas -->
            <div class="form-group full-width">
                <h3 style="margin-bottom: 1rem; color: var(--primary);">üìù Informa√ß√µes B√°sicas</h3>
            </div>

            <div class="form-group">
                <label for="nome">üìõ Nome do Produto *</label>
                <input type="text" id="nome" name="nome" class="form-control" 
                       value="{{ produto.nome if produto }}" required>
            </div>

            <div class="form-group">
                <label for="marca">üè∑Ô∏è Marca *</label>
                <input type="text" id="marca" name="marca" class="form-control" 
                       value="{{ produto.marca if produto }}" required>
            </div>

            <div class="form-group">
                <label for="categoria">üìÇ Categoria *</label>
                <input type="text" id="categoria" name="categoria" class="form-control" 
                       value="{{ produto.categoria if produto }}" 
                       placeholder="Ex: Notebooks, Perif√©ricos, Hardware..." required>
            </div>

            <div class="form-group">
                <label for="preco">üí∞ Pre√ßo *</label>
                <input type="number" id="preco" name="preco" class="form-control" step="0.01" min="0"
                       value="{{ "%.2f"|format(produto.preco) if produto }}" required>
            </div>

            <!-- Estoque e Status -->
            <div class="form-group">
                <label for="estoque">üì¶ Estoque *</label>
                <input type="number" id="estoque" name="estoque" class="form-control" min="0"
                       value="{{ produto.estoque if produto }}" required>
            </div>

            <div class="form-group">
                <label for="peso">‚öñÔ∏è Peso (kg)</label>
                <input type="number" id="peso" name="peso" class="form-control" step="0.01" min="0"
                       value="{{ produto.peso if produto }}">
            </div>

            <div class="form-group">
                <label for="dimensoes">üìè Dimens√µes (LxAxP)</label>
                <input type="text" id="dimensoes" name="dimensoes" class="form-control" 
                       value="{{ produto.dimensoes if produto }}" 
                       placeholder="Ex: 30x20x10 cm">
            </div>

            <!-- Configura√ß√µes -->
            <div class="form-group full-width">
                <h3 style="margin-bottom: 1rem; color: var(--primary);">‚öôÔ∏è Configura√ß√µes</h3>
            </div>

            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="destaque" {{ 'checked' if produto and produto.destaque }}>
                    ‚≠ê Produto em Destaque
                </label>
            </div>

            {% if produto %}
            <div class="form-group">
                <label style="display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" name="ativo" {{ 'checked' if produto.ativo }}>
                    ‚úÖ Produto Ativo
                </label>
            </div>
            {% endif %}

            <!-- Descri√ß√£o -->
            <div class="form-group full-width">
                <label for="descricao">üìÑ Descri√ß√£o do Produto</label>
                <textarea id="descricao" name="descricao" class="form-control" 
                          placeholder="Descreva as caracter√≠sticas, especifica√ß√µes e benef√≠cios do produto...">{{ produto.descricao if produto }}</textarea>
            </div>

            <!-- Upload de Imagens -->
            <div class="form-group full-width">
                <h3 style="margin-bottom: 1rem; color: var(--primary);">üñºÔ∏è Imagens do Produto</h3>
                
                <div class="image-upload">
                    <input type="file" id="imagens" name="imagens" multiple 
                           accept="image/*" class="form-control">
                    <p style="margin-top: 0.5rem; opacity: 0.7; font-size: 0.9rem;">
                        üìé Selecione m√∫ltiplas imagens (PNG, JPG, JPEG, GIF, WEBP)
                    </p>
                </div>

                <!-- Preview de Imagens Existentes -->
                {% if produto and produto.imagens %}
                <div class="image-preview">
                    {% for imagem in produto.imagens %}
                    <div class="preview-item">
                        <img src="{{ url_for('static', filename='uploads/produtos/' + imagem) }}" 
                             alt="Imagem do produto">
                        <button type="button" class="preview-remove" 
                                onclick="removerImagem('{{ imagem }}')">√ó</button>
                        <input type="hidden" name="imagens_manter" value="{{ imagem }}">
                    </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>

        <div class="form-actions">
            <a href="{{ url_for('admin_produtos') }}" class="btn btn-warning">
                ‚Ü©Ô∏è Cancelar
            </a>
            <button type="submit" class="btn btn-primary">
                üíæ {{ 'Atualizar' if produto else 'Cadastrar' }} Produto
            </button>
        </div>
    </form>
</div>

<script>
    function removerImagem(imagem) {
        const previewItem = event.target.closest('.preview-item');
        previewItem.remove();
    
        // marca imagem para remo√ß√£o
        const form = document.querySelector('form');
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'imagens_remover';
        input.value = imagem;
        form.appendChild(input);
    }
    
    document.getElementById('imagens').addEventListener('change', function(e) {
        // usa o preview existente, sem duplicar
        let preview = document.querySelector('.image-preview');
        if (!preview) {
            preview = createPreviewContainer();
        }
    
        // limpa previews de arquivos novos (sem apagar as imagens existentes)
        preview.querySelectorAll('.preview-item[data-novo="true"]').forEach(item => item.remove());
    
        Array.from(e.target.files).forEach(file => {
            if (!file.type.startsWith('image/')) return;
    
            const reader = new FileReader();
            reader.onload = function(ev) {
                const previewItem = document.createElement('div');
                previewItem.className = 'preview-item';
                previewItem.dataset.novo = "true"; // marca como nova imagem
                previewItem.innerHTML = `
                    <img src="${ev.target.result}" alt="Preview">
                    <button type="button" class="preview-remove" onclick="this.parentElement.remove()">√ó</button>
                `;
                preview.appendChild(previewItem);
            };
            reader.readAsDataURL(file);
        });
    });
    
    function createPreviewContainer() {
        const container = document.createElement('div');
        container.className = 'image-preview';
        document.querySelector('.image-upload').after(container);
        return container;
    }
    </script>
    

<style>
.image-preview {
    margin-top: 1.5rem;
}

.preview-item {
    position: relative;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.preview-item img {
    width: 100%;
    height: 100px;
    object-fit: cover;
}

.preview-remove {
    position: absolute;
    top: 5px;
    right: 5px;
    background: var(--danger);
    color: white;
    border: none;
    border-radius: 50%;
    width: 24px;
    height: 24px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: bold;
}
</style>
{% endblock %}