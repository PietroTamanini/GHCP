{% extends 'base.html' %}
{% set titulo = "Finalizar Compra" %}
{% block conteudo %}

<style>
.checkout-container {
    max-width: 700px;
    margin: 50px auto;
    background: var(--glass);
    padding: 40px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    border: 1px solid var(--border);
}
.checkout-container h2 {
    text-align: center;
    font-size: 2.5em;
    font-weight: 800;
    color: var(--primary);
    margin-bottom: 30px;
}
.checkout-container form {
    display: flex;
    flex-direction: column;
    gap: 15px;
}
.checkout-container label {
    font-weight: 600;
    color: var(--text);
}
.checkout-container input, 
.checkout-container select {
    padding: 10px;
    border-radius: 8px;
    border: 2px solid var(--border);
    background-color: var(--secondary);
    color: var(--text);
    font-weight: 600;
}
.checkout-container input:focus, 
.checkout-container select:focus {
    outline: none;
    border-color: var(--primary);
    box-shadow: 0 0 0 4px rgba(0, 102, 255, 0.2);
}
.btn-finalizar {
    background: linear-gradient(135deg, var(--success) 0%, #00b36e 100%);
    color: white;
    padding: 15px;
    border-radius: 10px;
    font-weight: 700;
    font-size: 1.2em;
    border: none;
    cursor: pointer;
    transition: var(--transition);
}
.btn-finalizar:hover {
    transform: translateY(-3px);
    box-shadow: var(--shadow);
}
.hidden {
    display: none;
}
.card-form {
    background: rgba(0, 102, 255, 0.05);
    padding: 20px;
    border-radius: 12px;
    border: 2px solid var(--border);
}
.card-brands {
    display: flex;
    gap: 10px;
    margin-top: 10px;
    flex-wrap: wrap;
}
.card-brand {
    width: 50px;
    height: 30px;
    border-radius: 4px;
    background: white;
    display: flex;
    align-items: center;
    justify-content: center;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    font-size: 10px;
    font-weight: bold;
}
</style>

<div class="checkout-container">
    <h2>üí≥ Finalizar Compra</h2>
    <form id="form-checkout" method="POST" action="{{ url_for('processar_pagamento_cartao') }}">
        <label>Nome Completo</label>
        <input type="text" name="nome" id="form-checkout__cardholderName" required>

        <label>Email</label>
        <input type="email" name="email" id="form-checkout__cardholderEmail" required>

        <label>CPF</label>
        <input type="text" name="cpf_titular" id="form-checkout__identificationNumber" 
               placeholder="000.000.000-00" required maxlength="14">

        <label>Endere√ßo</label>
        <input type="text" name="endereco" required>

        <label>Forma de Pagamento</label>
        <select id="pagamento" name="pagamento" required>
            <option value="">Selecione</option>
            <option value="pix">PIX (10% desconto)</option>
            <option value="boleto">Boleto (5% desconto)</option>
            <option value="cartao">Cart√£o de Cr√©dito/D√©bito</option>
        </select>

        <!-- CAMPOS DO CART√ÉO -->
        <div id="cartao-info" class="hidden card-form">
            <h3 style="margin-bottom: 15px; color: var(--primary);">üí≥ Dados do Cart√£o</h3>
            
            <label>Tipo de Cart√£o</label>
            <select id="tipo-cartao" name="tipo_pagamento">
                <option value="credito">Cr√©dito</option>
                <option value="debito">D√©bito</option>
            </select>

            <label>N√∫mero do Cart√£o</label>
            <input type="text" id="form-checkout__cardNumber" placeholder="0000 0000 0000 0000" 
                   maxlength="19" required>
            
            <div class="card-brands">
                <div class="card-brand">VISA</div>
                <div class="card-brand">MASTER</div>
                <div class="card-brand">ELO</div>
                <div class="card-brand">AMEX</div>
            </div>

            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
                <div>
                    <label>Validade (MM/AA)</label>
                    <input type="text" id="form-checkout__expirationDate" 
                           placeholder="12/28" maxlength="5" required>
                </div>
                <div>
                    <label>CVV</label>
                    <input type="text" id="form-checkout__securityCode" 
                           placeholder="123" maxlength="4" required>
                </div>
            </div>

            <div id="credito-info" class="hidden" style="margin-top: 15px;">
                <label>Parcelamento</label>
                <select id="form-checkout__installments" name="parcelas">
                    <option value="1">1x sem juros</option>
                    <option value="2">2x sem juros</option>
                    <option value="3">3x sem juros</option>
                    <option value="4">4x sem juros</option>
                    <option value="5">5x sem juros</option>
                    <option value="6">6x sem juros</option>
                    <option value="7">7x com juros</option>
                    <option value="8">8x com juros</option>
                    <option value="9">9x com juros</option>
                    <option value="10">10x com juros</option>
                    <option value="11">11x com juros</option>
                    <option value="12">12x com juros</option>
                </select>
                <p id="valor-parcela" style="font-weight:600; color:var(--primary); margin-top:10px;"></p>
            </div>

            <input type="hidden" name="token" id="token">
        </div>

        <p>Total a Pagar: 
            <strong id="total" style="font-size: 1.5em; color: var(--primary);">
                R$ {{ "%.2f"|format(total_geral) }}
            </strong>
        </p>
        <button type="submit" class="btn-finalizar" id="btn-submit">üí∞ Confirmar Compra</button>
    </form>
</div>

<script src="https://sdk.mercadopago.com/js/v2"></script>
<script>
const pagamento = document.getElementById('pagamento');
const cartaoInfo = document.getElementById('cartao-info');
const tipoCartao = document.getElementById('tipo-cartao');
const creditoInfo = document.getElementById('credito-info');
const parcelasSelect = document.getElementById('form-checkout__installments');
const valorParcela = document.getElementById('valor-parcela');
const total = parseFloat("{{ total_geral }}");

// Mostrar/Ocultar campos do cart√£o
pagamento.addEventListener('change', () => {
    if (pagamento.value === 'cartao') {
        cartaoInfo.classList.remove('hidden');
        carregarMercadoPago();
    } else {
        cartaoInfo.classList.add('hidden');
    }
});

// Mostrar parcelamento apenas para cr√©dito
tipoCartao.addEventListener('change', () => {
    if (tipoCartao.value === 'credito') {
        creditoInfo.classList.remove('hidden');
    } else {
        creditoInfo.classList.add('hidden');
    }
});

// Calcular valor das parcelas
parcelasSelect.addEventListener('change', () => {
    const parcelas = parseInt(parcelasSelect.value);
    let totalComJuros = total;
    
    if (parcelas > 6) {
        totalComJuros *= 1.05; // 5% de juros total
    }
    
    const valorPorParcela = totalComJuros / parcelas;
    valorParcela.textContent = `Total: R$ ${totalComJuros.toFixed(2)} ‚Äî ${parcelas}x de R$ ${valorPorParcela.toFixed(2)}`;
});

// M√°scaras de entrada
document.getElementById('form-checkout__identificationNumber').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 11) value = value.slice(0, 11);
    if (value.length > 9) {
        value = value.slice(0, 3) + '.' + value.slice(3, 6) + '.' + value.slice(6, 9) + '-' + value.slice(9);
    } else if (value.length > 6) {
        value = value.slice(0, 3) + '.' + value.slice(3, 6) + '.' + value.slice(6);
    } else if (value.length > 3) {
        value = value.slice(0, 3) + '.' + value.slice(3);
    }
    e.target.value = value;
});

document.getElementById('form-checkout__cardNumber').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 16) value = value.slice(0, 16);
    value = value.replace(/(\d{4})(?=\d)/g, '$1 ');
    e.target.value = value;
});

document.getElementById('form-checkout__expirationDate').addEventListener('input', function(e) {
    let value = e.target.value.replace(/\D/g, '');
    if (value.length > 4) value = value.slice(0, 4);
    if (value.length >= 2) {
        value = value.slice(0, 2) + '/' + value.slice(2);
    }
    e.target.value = value;
});

// ============================================
// INTEGRA√á√ÉO MERCADO PAGO
// ============================================
let mp;

async function carregarMercadoPago() {
    try {
        const response = await fetch('/obter-public-key');
        const data = await response.json();
        mp = new MercadoPago(data.public_key);
        
        const cardForm = mp.cardForm({
            amount: total.toFixed(2),
            iframe: false,
            form: {
                id: "form-checkout",
                cardNumber: {
                    id: "form-checkout__cardNumber",
                    placeholder: "N√∫mero do cart√£o",
                },
                expirationDate: {
                    id: "form-checkout__expirationDate",
                    placeholder: "MM/AA",
                },
                securityCode: {
                    id: "form-checkout__securityCode",
                    placeholder: "CVV",
                },
                cardholderName: {
                    id: "form-checkout__cardholderName",
                    placeholder: "Titular do cart√£o",
                },
                installments: {
                    id: "form-checkout__installments",
                    placeholder: "Parcelas",
                },
                identificationType: {
                    id: "form-checkout__identificationType",
                },
                identificationNumber: {
                    id: "form-checkout__identificationNumber",
                    placeholder: "CPF",
                },
                issuer: {
                    id: "form-checkout__issuer",
                    placeholder: "Banco emissor",
                },
            },
            callbacks: {
                onFormMounted: error => {
                    if (error) {
                        console.warn("Form Mounted handling error: ", error);
                    }
                    console.log("Form mounted");
                },
                onSubmit: event => {
                    event.preventDefault();
                    const form = document.getElementById('form-checkout');
                    
                    cardForm.createCardToken().then(token => {
                        document.getElementById('token').value = token.id;
                        form.submit();
                    }).catch(error => {
                        console.error("Erro ao criar token:", error);
                        alert("Erro ao processar o cart√£o. Verifique os dados.");
                    });
                },
            },
        });
    } catch (error) {
        console.error('Erro ao carregar Mercado Pago:', error);
        alert('Erro ao carregar sistema de pagamento. Tente novamente.');
    }
}
</script>

{% endblock %}